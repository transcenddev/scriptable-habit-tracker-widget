// Pretty Progress Habit Streak Widget for Scriptable

// ===================================================
// USER CONFIGURATION
// ===================================================

// STEP 1: Customize your habit
const habitName = "Meditation";    // Your habit name
const streakCount = 57;           // Your current streak (max 365)

// STEP 2: Visual Customization
const BG_IMAGE_URL = "";          // Add image URL or leave blank
const BG_COLOR = "#18181b";       // Background/overlay color
const BG_OVERLAY_OPACITY = 0.95;  // Overlay opacity (0-1)

// Color settings for dots
const filledDotColor = new Color("#ffffff");         // Completed days
const emptyDotColor = new Color("#444444", 0.6);    // Remaining days

// Layout Configuration
// These are optimized for iPhone 15 Pro. You may need to adjust for different devices.
const WIDGET_WIDTH = 320;         // Base widget width
const PADDING = 8;               // Space around the edges of the widget
const CIRCLE_SIZE = 6;           // Size of the progress dots
const CIRCLE_SPACING = 4;        // Space between dots
const TEXT_SPACING = 8;          // Space between dot grid and text
const DOT_SHIFT_LEFT = 2;        // Slight left shift for dots
const YEAR_OFFSET = DOT_SHIFT_LEFT - 2;  // Offset for year text
const DAYS_LEFT_OFFSET = 0;      // Offset for days left text
const cornerRadius = 18;         // Widget corner radius

// Calculate grid dimensions
const AVAILABLE_WIDTH = WIDGET_WIDTH - (2 * PADDING);
const TOTAL_CIRCLE_WIDTH = CIRCLE_SIZE + CIRCLE_SPACING;
const COLUMNS = 25;  // Fixed number of columns
const ROWS = 15;     // Fixed number of rows

// Font Configuration
const MENLO_REGULAR = new Font("Menlo", 12);
const MENLO_BOLD = new Font("Menlo-Bold", 12);

// Create widget
let w = new ListWidget();
w.cornerRadius = cornerRadius;

// Set up background
if (BG_IMAGE_URL) {
    try {
        const req = new Request(BG_IMAGE_URL);
        const bgImage = await req.loadImage();
        w.backgroundImage = bgImage;
    } catch (e) {
        console.log("Couldn't load background image");
    }
}

// Add gradient overlay
const overlay = new LinearGradient();
overlay.locations = [0, 1];
overlay.colors = [
    new Color(BG_COLOR, BG_OVERLAY_OPACITY),
    new Color(BG_COLOR, BG_OVERLAY_OPACITY)
];
w.backgroundGradient = overlay;

w.setPadding(PADDING, PADDING, PADDING, PADDING);

// Create grid container
const gridContainer = w.addStack();
gridContainer.layoutVertically();

// Build the dot grid
let dotIndex = 0;
for (let row = 0; row < ROWS; row++) {
    const rowStack = gridContainer.addStack();
    rowStack.layoutHorizontally();
    rowStack.centerAlignContent();
    
    // Add the left shift
    rowStack.addSpacer(DOT_SHIFT_LEFT);
    
    for (let col = 0; col < COLUMNS; col++) {
        if (dotIndex < 365) {
            const dot = rowStack.addText("â€¢");
            dot.font = Font.systemFont(CIRCLE_SIZE);
            dot.textColor = (dotIndex < streakCount) ? filledDotColor : emptyDotColor;
            dotIndex++;
            if (col < COLUMNS - 1) rowStack.addSpacer(CIRCLE_SPACING);
        }
    }
    if (row < ROWS - 1) gridContainer.addSpacer(CIRCLE_SPACING);
}

w.addSpacer(TEXT_SPACING);

// Bottom row with habit name and streak count
const footer = w.addStack();
footer.layoutHorizontally();

// Habit name (left)
const eventStack = footer.addStack();
eventStack.addSpacer(YEAR_OFFSET);
const nameText = eventStack.addText(habitName);
nameText.font = MENLO_BOLD;
nameText.textColor = filledDotColor;
nameText.lineLimit = 1;

const textWidth = `${streakCount} days streak`.length * 7.5;
const availableSpace = WIDGET_WIDTH - (PADDING * 2) - YEAR_OFFSET - (nameText.text.length * 7.5);
const spacerLength = availableSpace - textWidth + DAYS_LEFT_OFFSET;
footer.addSpacer(spacerLength);

// Streak count (right)
const streakText = footer.addText(`${streakCount} day${streakCount === 1 ? "" : "s"}`);
streakText.font = MENLO_REGULAR;
streakText.textColor = new Color("#ffffff", 0.8);
streakText.lineLimit = 1;

// Present widget
if (config.runsInWidget) {
    Script.setWidget(w);
} else {
    await w.presentMedium();
}
Script.complete();